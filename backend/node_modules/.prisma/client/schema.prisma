// Prisma schema for Ops MVP

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum TaskStatus {
  REQUIRES_ATTENTION
  AT_RISK
  IN_PROGRESS
  COMPLETE
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

model User {
  id                 String         @id @default(cuid())
  email              String         @unique
  username           String
  passwordHash       String?
  otpValue           String?
  otpExpiresAt       DateTime?
  memberships        Membership[]
  messages           TaskMessage[]  @relation("MessageAuthor")
  organizationsOwned Organization[] @relation("OrgOwner")
  tasksOwned         Task[]         @relation("TaskOwner")
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  @@index([username])
}

model Organization {
  id          String       @id @default(cuid())
  name        String
  ownerId     String
  owner       User         @relation("OrgOwner", fields: [ownerId], references: [id])
  memberships Membership[]
  teams       Team[]
  invites     Invite[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([name])
  @@index([ownerId])
}

model Membership {
  id             String       @id @default(cuid())
  userId         String
  organizationId String
  role           OrgRole      @default(MEMBER)
  user           User         @relation(fields: [userId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id])
  createdAt      DateTime     @default(now())

  @@unique([userId, organizationId])
  @@index([organizationId, role])
}

model Team {
  id             String       @id @default(cuid())
  name           String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  taskLists      TaskList[]
  createdAt      DateTime     @default(now())

  @@index([organizationId])
}

model TaskList {
  id        String   @id @default(cuid())
  name      String
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id])
  tasks     Task[]
  createdAt DateTime @default(now())

  @@index([teamId])
}

model Task {
  id          String        @id @default(cuid())
  title       String
  description String?
  status      TaskStatus    @default(REQUIRES_ATTENTION)
  taskListId  String
  ownerId     String?
  taskList    TaskList      @relation(fields: [taskListId], references: [id])
  owner       User?         @relation("TaskOwner", fields: [ownerId], references: [id])
  messages    TaskMessage[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([taskListId, status])
  @@index([ownerId])
}

model TaskMessage {
  id        String   @id @default(cuid())
  taskId    String
  authorId  String
  body      String
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id])
  author    User     @relation("MessageAuthor", fields: [authorId], references: [id])

  @@index([taskId, createdAt])
}

model Invite {
  id             String       @id @default(cuid())
  organizationId String
  token          String       @unique
  expiresAt      DateTime
  usedAt         DateTime?
  organization   Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId, expiresAt])
}
